#!/usr/bin/env bash
# Auto-generated by CMake - DO NOT EDIT MANUALLY
# This script allows building without CMake installed

set -e
cd "$(dirname "$0")/libvscode-diff"

# Detect platform for library extension
if [[ "$OSTYPE" == "darwin"* ]]; then
    PLATFORM="Darwin"
    LIB_EXT="dylib"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    PLATFORM="Linux"
    LIB_EXT="so"
else
    PLATFORM="Unknown"
    LIB_EXT="so"
fi

# Auto-detect compiler (respect CC environment variable)
if [ -z "$CC" ]; then
    if command -v cc >/dev/null 2>&1; then
        CC="cc"
    elif command -v gcc >/dev/null 2>&1; then
        CC="gcc"
    elif command -v clang >/dev/null 2>&1; then
        CC="clang"
    else
        echo "Error: No C compiler found (tried: cc, gcc, clang)"
        exit 1
    fi
fi

echo "Building vscode_diff (standalone mode)..."
echo "Compiler: $CC"
echo "Platform: $PLATFORM"

# Compiler flags
CFLAGS="-Wall -Wextra -std=c11 -O2 -DNDEBUG -DUTF8PROC_STATIC -D_POSIX_C_SOURCE=199309L -Iinclude -Ibuild/include -Ivendor -fPIC"
LDFLAGS="-shared"

# Add -lm for math library on Unix
if [[ "$PLATFORM" != "Darwin" ]]; then
    LDFLAGS="$LDFLAGS -lm"
fi

# Source files (including bundled utf8proc)
SOURCES="\
default_lines_diff_computer.c \
src/char_level.c \
src/line_level.c \
src/myers.c \
src/optimize.c \
src/sequence.c \
src/range_mapping.c \
src/string_hash_map.c \
src/utils.c \
src/print_utils.c \
src/utf8_utils.c \
vendor/utf8proc.c"

# Build
mkdir -p build
mkdir -p build/include

# Generate version.h
VERSION=$(cat ../VERSION | tr -d '[:space:]')
sed "s/@''PROJECT_VERSION@/$VERSION/g" include/version.h.in > build/include/version.h

echo "Compiling..."
$CC $CFLAGS $LDFLAGS -o libvscode_diff.$LIB_EXT $SOURCES

echo "Installing to plugin root..."
cp libvscode_diff.$LIB_EXT ../libvscode_diff.$LIB_EXT

echo "âœ“ Build successful: libvscode_diff.$LIB_EXT"
cd ..
